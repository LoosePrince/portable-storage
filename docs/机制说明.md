# 机制说明

## 木桶升级使用说明

### 绑定机制

**首次绑定**
1. 玩家A将普通木桶放入升级槽位
2. 木桶自动绑定到玩家A，成为"绑定木桶"
3. 玩家A可以将绑定木桶从升级槽位取出作为方块放置到世界中

**绑定转移**
1. 玩家A将绑定木桶从升级槽位取出
2. 绑定木桶作为物品丢出或交易给其他玩家
3. 玩家B拾取这个绑定木桶并放入自己的升级槽位
4. 现在玩家B的仓库与玩家A的仓库共享（合并显示）

### 仓库共享机制

**共享显示**
- 当玩家B使用玩家A的绑定木桶时，玩家的仓库界面会显示合并后的物品列表
- 物品的提取和存入遵循优先级：优先操作自己的仓库
- 支持多玩家同时共享同一仓库组

**多玩家共享**
- 玩家A的绑定木桶可以被多个玩家同时使用
- 所有使用该绑定木桶的玩家都共享同一个仓库视图
- 系统会自动处理物品的同步和一致性

### 自动化设备交互

**绑定木桶方块**
1. 将绑定木桶作为方块放置到世界中
2. 右键打开可以手动存入物品到共享仓库
3. 自动化设备（如漏斗）可以：
   - 从绑定木桶中提取仓库内存在的物品
   - 向绑定木桶输入物品到共享仓库
   - 绑定木桶内的物品不会被自动化设备取出（需放入0号槽位作为标记）

### 适配

- 仅适配原版漏斗和投掷器的存入
- 仅视频原版漏斗机制取出

如需适配工业化模组请提issues

### 限制机制

**防循环共享**
- 系统防止玩家间形成循环共享关系
- 如果玩家B已经使用了玩家A的绑定木桶，玩家A就无法再使用玩家B的绑定木桶
- 避免无限循环的仓库共享链

## 同步机制（增量 + 兜底全量）

### 会话与序号
- 服务器为每位玩家维护一个会话 `sessionId`，每次全量同步都会开启新会话。
- 同一会话内的增量包使用单调递增的 `seq` 序号；客户端按序应用。

### 增量包（diff）
- S2C 载荷包含：`sessionId`、`seq`、`diff`。
- `diff` 分为两类条目：
  - upserts: 新增或更新的变体（包含展示 `ItemStack`、数量 `count`、时间戳 `ts`）。
  - removes: 从当前可见集合中移除的变体键。
- 为降低带宽，服务器仅下发与“上次快照”相比发生变化的条目。
- 若条目过多，按 `incremental_sync_max_entries` 分包发送。

### 客户端应用与 ACK
- 客户端按 `sessionId/seq` 校验并就地更新 UI 状态，减少抖动。
- 每次应用增量后立即发送 ACK（含 `seq`）；异常（会话或序号不匹配）会自动请求全量回退。

### 按需与节流
- 当 `enable_on_demand_sync = true` 时，仅在玩家查看仓库界面时周期性推送增量；否则对所有在线玩家推送。
- 推送间隔由 `incremental_sync_interval_ticks` 控制，可运行时热更新。

### 兜底全量
- 服务器发送的全量包携带 `sessionId`，客户端收到后重置会话并替换本地状态。
- 出现缺包/乱序或其他异常时，客户端会请求全量回退以自愈。

## 拼音搜索机制

### 搜索匹配流程

1. **直接文本匹配**：优先进行直接的中文文本匹配
2. **拼音转换匹配**：如果直接匹配失败，则进行拼音转换匹配
3. **多音字处理**：自动识别多音字并尝试所有可能的读音
4. **大小写不敏感**：支持大小写混合输入

### 拼音转换机制

#### 默认拼音转换
- 使用 TinyPinyin 库进行中文转拼音
- 拼音音节之间使用空格分隔符
- 例如："钻石剑" → "zuan shi jian"

#### 多音字处理
- 多音字映射表存储在客户端配置文件中
- 支持运行时动态添加/移除多音字
- 生成所有可能的拼音组合进行匹配
- 例如："镐" → ["gao", "hao"]

#### 拼音首字母提取
- 按空格分割拼音音节
- 提取每个音节的第一个字母
- 例如："zuan shi jian" → "zsj"

### 配置热修改机制

#### 多音字配置
- 配置存储在 `config/portable-storage-client.json` 中
- 支持 JSON 格式的多音字映射表
- 配置修改后自动保存到文件

#### 热重载功能
- 支持运行时重新加载配置文件
- 多音字映射表修改后立即生效
- 无需重启客户端即可应用配置更改

### 性能优化

#### 匹配策略
- 优先进行直接文本匹配（最快）
- 仅在直接匹配失败时才进行拼音转换
- 多音字处理仅在包含多音字时触发

#### 缓存机制
- 拼音转换结果可以缓存以提高性能
- 多音字映射表在内存中维护
- 配置热重载时更新内存中的映射表